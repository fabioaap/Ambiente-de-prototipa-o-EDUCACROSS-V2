name: Sprint 3 Auto Executor

# Workflow para executar automaticamente issues seguindo depend√™ncias
# Pode ser executado manualmente ou via schedule

on:
  # Execu√ß√£o manual via GitHub UI
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Executar em modo dry-run (simula√ß√£o)'
        required: true
        type: boolean
        default: true

  # Execu√ß√£o agendada (desabilitada por padr√£o, descomentar para ativar)
  # schedule:
  #   - cron: '0 */12 * * *'  # A cada 12 horas

# Permiss√µes necess√°rias para o workflow
permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read

jobs:
  execute-issues:
    name: Execute Issues Auto
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necess√°rio para criar branches

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r scripts/requirements.txt

      - name: Run Sprint 3 Auto Executor
        id: executor
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "üîç Executando em modo DRY RUN (simula√ß√£o)"
            python3 scripts/sprint3_auto_executor.py --dry-run
          else
            echo "‚ö° Executando em modo REAL"
            python3 scripts/sprint3_auto_executor.py
          fi
        continue-on-error: true

      - name: Upload execution report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sprint3-executor-report-${{ github.run_id }}
          path: |
            report-*.md
            sprint3-autoexecutor-*.log
          retention-days: 30

      - name: Display report summary
        if: always()
        run: |
          echo "## üìä Sprint 3 Auto Executor - Resumo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f report-*.md ]; then
            REPORT_FILE=$(ls -t report-*.md | head -1)
            echo "### Relat√≥rio Gerado" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Nenhum relat√≥rio gerado" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check execution status
        if: steps.executor.outcome == 'failure'
        run: |
          echo "‚ùå Execu√ß√£o falhou. Verifique os logs acima."
          exit 1

      - name: Success message
        if: steps.executor.outcome == 'success'
        run: |
          echo "‚úÖ Execu√ß√£o conclu√≠da com sucesso!"
          echo "üìÑ Relat√≥rio dispon√≠vel nos artifacts"
