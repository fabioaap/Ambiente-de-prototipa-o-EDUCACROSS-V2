# Copilot Instructions

- Context: prototyping monorepo (Next.js + Puck Studio + Storybook) on Node 22.21.1 / pnpm 9.14+ / TypeScript strict; keep builds/dev flows clean for designers.
- Topology: apps (studio dashboard + Storybook hub), packages (design-system, tokens, eslint-config), domains (BackOffice/FrontOffice/Game journeys + docs), and code-to-figma (figma-mcp-server + figma-sync-engine).
- Build chain: `pnpm build:tokens` → `pnpm build:design-system` → `pnpm build` (or `pnpm build:hub` for Storybook). Install with `pnpm install --frozen-lockfile`. Use `pnpm --filter <pkg> <cmd>` when a package stalls on Windows.
- Dev servers: `pnpm dev:studio` (Next.js + Puck, port 3000), `pnpm dev:hub`/`dev:storybook` (Storybook, port 6006). Shadcn imports (`@/components/ui/*`) allowed only in studio/dashboard routes; guard with `pnpm check:shadcn`.
- Design System: components live in [packages/design-system](packages/design-system) using CSS Modules and tokens; export via `src/index.ts`. New components need `'use client'`, `React.forwardRef`, typed props (no `any`), CSS module, Storybook story under [domains/storybook/src/stories](domains/storybook/src/stories). Tokens source is [packages/tokens/src/tokens.json](packages/tokens/src/tokens.json); rebuild via `pnpm build:tokens` and import `dist/tokens.css`.
- Puck integration: component contract sits in [domains/studio/src/config/puck.config.tsx](domains/studio/src/config/puck.config.tsx); JSON pages live in [domains/studio/data/pages](domains/studio/data/pages). Keep props in sync with design-system or pages break.
- Journeys: each `domains/{domain}/journeys/{journey}` must ship `README.md`, `notas.md`, `links.md`; only use `@prototipo/design-system` components. After creating journeys run `pnpm gen:journeys` and update [domains/README.md](domains/README.md).
- API patterns: Next.js App Router handlers under studio/dashboard use `Response.json` with typed payloads; keep `/api/dashboard/summary` and `/api/dashboard/health` response shapes consistent with mocks in the dashboard UI.
- Testing: Vitest across packages (`vitest.config.ts` per package); use `play()` interaction tests in Storybook stories. Coverage gates on figma-mcp-server: ≥80% statements/functions, ≥75% branches.
- Quality gates before PR: `pnpm build`, `pnpm lint`, `pnpm type-check`, `pnpm check:shadcn`; ensure Storybook and Studio run without console errors. Branch naming `feature/sprint6-{item}`; commits `type(scope): summary (issue #XX)`; SpecKit runs via `/spec` comment on PR.
- Code-to-Figma: two subsystems. figma-mcp-server ([code-to-figma/figma-mcp-server](code-to-figma/figma-mcp-server)) exposes MCP tools `get_design_tokens` and `get_frame_snapshot`; requires `FIGMA_ACCESS_TOKEN` for live tests. figma-sync-engine ([code-to-figma/figma-sync-engine](code-to-figma/figma-sync-engine)) pipeline: Storybook addon capture (`packages/storybook-addon-export/captureHtml.ts` whitelist) → HTML→Figma core → AutoLayout interpreter → plugin rebuild; update `docs/figma-json-format.md` when schema changes.
- ESLint config: shared presets in [packages/eslint-config](packages/eslint-config) (base/next/storybook). Prefer reuse over ad-hoc rules; lint via `pnpm lint` or filtered runs.
- Accessibility: design-system components target WCAG 2.1 AA; provide `aria-label` for icon buttons and keep focus styles intact. Storybook has a11y addon; dashboards use skeleton → data → error fallback pattern.
- Helpful references: root overview in [README.md](README.md); design system usage in [packages/design-system/README.md](packages/design-system/README.md); Storybook guidance in [domains/storybook/README.md](domains/storybook/README.md); Studio behavior in [domains/studio/README.md](domains/studio/README.md). For design-system evolution process see [DS_CONTINUOUS_EVOLUTION_SYSTEM.md](DS_CONTINUOUS_EVOLUTION_SYSTEM.md) and [DESIGN_SYSTEM_REAL_GAP_ANALYSIS.md](DESIGN_SYSTEM_REAL_GAP_ANALYSIS.md).
